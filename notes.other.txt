
################################################
# ALTERNATE WAY TO BUILD SWIG WRAPPERS - WINDOWS
################################################

# QuantExt-SWIG
5.1 Use cmake to generate the project files

cd %DEMO_ORE_SWIG_DIR%\buildQuantExt-SWIG
"C:\Program Files\CMake\bin\cmake.exe" -G "Visual Studio 17 2022" ^
-A x64 ^
-D SWIG_DIR=%DEMO_SWIG_DIR%\Lib ^
-D SWIG_EXECUTABLE=%DEMO_SWIG_DIR%\swig.exe ^
-D ORE:PATHNAME=%DEMO_ORE_DIR% ^
-D BOOST_ROOT=%DEMO_BOOST_DIR% ^
-S %DEMO_ORE_SWIG_DIR%\QuantExt-SWIG\Python
-> %DEMO_ORE_SWIG_DIR%\buildQuantExt-SWIG\QuantExt-Python.sln

5.1.1 EITHER Build the pyd file using Visual Studio

%DEMO_ORE_SWIG_DIR%\buildQuantExt-SWIG\QuantExt-Python.sln
-> %DEMO_ORE_SWIG_DIR%\buildQuantExt-SWIG\Release\_QuantExt.pyd

5.1.2 OR Build the pyd file using cmake

cd %DEMO_ORE_SWIG_DIR%\buildQuantExt-SWIG
"C:\Program Files\CMake\bin\cmake.exe" --build . --config Release
-> %DEMO_ORE_SWIG_DIR%\buildQuantExt-SWIG\Release\_QuantExt.pyd

# ORE-SWIG
3.1 Use cmake to generate the project files

cd %DEMO_ORE_SWIG_DIR%
mkdir buildOREAnalytics-SWIG
cd %DEMO_ORE_SWIG_DIR%\buildOREAnalytics-SWIG
"C:\Program Files\CMake\bin\cmake.exe" -G "Visual Studio 17 2022" ^
-A x64 ^
-D SWIG_DIR=%DEMO_SWIG_DIR%\Lib ^
-D SWIG_EXECUTABLE=%DEMO_SWIG_DIR%\swig.exe ^
-D ORE:PATHNAME=%DEMO_ORE_DIR% ^
-D BOOST_ROOT=%DEMO_BOOST_DIR% ^
-S %DEMO_ORE_SWIG_DIR%\OREAnalytics-SWIG\Python
-> %DEMO_ORE_SWIG_DIR%\buildOREAnalytics-SWIG\OREAnalytics-Python.sln

3.1.1 EITHER Build the pyd file using Visual Studio

%DEMO_ORE_SWIG_DIR%\buildOREAnalytics-SWIG\OREAnalytics-Python.sln
-> %DEMO_ORE_SWIG_DIR%\buildOREAnalytics-SWIG\Release\_OREAnalytics.pyd

3.1.2 OR Build the pyd file using cmake

cd %DEMO_ORE_SWIG_DIR%\buildOREAnalytics-SWIG
"C:\Program Files\CMake\bin\cmake.exe" --build . --config Release
-> %DEMO_ORE_SWIG_DIR%\buildOREAnalytics-SWIG\Release\_OREAnalytics.pyd

##############################################
# ALTERNATE WAY TO BUILD SWIG WRAPPERS - LINUX
##############################################

# QuantExt-SWIG

4.1 Use cmake to generate the project files

cd $DEMO_ORE_SWIG_DIR
mkdir buildQuantExt-SWIG
cd $DEMO_ORE_SWIG_DIR/buildQuantExt-SWIG
cmake -DORE:PATHNAME=$DEMO_ORE_DIR -DBOOST_ROOT=$DEMO_BOOST_DIR -S$DEMO_ORE_SWIG_DIR/QuantExt-SWIG/Python
-> $DEMO_ORE_SWIG_DIR/buildQuantExt-SWIG/Makefile

4.1.1 EITHER Build the pyd file using make

cd $DEMO_ORE_SWIG_DIR/buildQuantExt-SWIG
make
-> $DEMO_ORE_SWIG_DIR/buildQuantExt-SWIG/_QuantExt.so

4.1.2 OR Build the pyd file using cmake

cd $DEMO_ORE_SWIG_DIR/buildQuantExt-SWIG
cmake --build .
-> $DEMO_ORE_SWIG_DIR/buildQuantExt-SWIG/_QuantExt.so

# ORE-SWIG

7.1 Use cmake to generate the project files

cd $DEMO_ORE_SWIG_DIR
mkdir buildOREAnalytics-SWIG
cd $DEMO_ORE_SWIG_DIR/buildOREAnalytics-SWIG
cmake -DBOOST_ROOT=$DEMO_BOOST_DIR -DORE=$DEMO_ORE_DIR -S$DEMO_ORE_SWIG_DIR/OREAnalytics-SWIG/Python -Wno-dev
-> $DEMO_ORE_SWIG_DIR/buildOREAnalytics-SWIG/Makefile

7.1.1 EITHER Build the pyd file using make

cd $DEMO_ORE_SWIG_DIR/buildOREAnalytics-SWIG
make # swap space
-> $DEMO_ORE_SWIG_DIR/buildOREAnalytics-SWIG/_OREAnalytics.so

7.1.2 OR Build the pyd file using cmake

cd $DEMO_ORE_SWIG_DIR/buildOREAnalytics-SWIG
cmake --build .
-> $DEMO_ORE_SWIG_DIR/buildOREAnalytics-SWIG/_OREAnalytics.so

========
PROBLEMS
========

- QuantLib uses only boost header files, ORE requires boost libs
- setup:
  1) QuantLib setup.py calls quantlib-config which is generated by configure
  2) ORE setup.py calls oreanalytics-config which is handwritten
  - for #2, oreanalytics-config requires environment variables which in the CI do not get passed
    from setup.py (because cibuildwheels does not export them?) (CIBW_ENVIRONMENT_PASS_LINUX?)
- timeout:
  "The job running on runner GitHub Actions 2 has exceeded the maximum execution time of 360 minutes."
- boost libs on macos - symbolic link

===============
# simulate the job - Windows

# build boost
cd C:\local\boost_installers
boost_1_80_0-msvc-14.3-32.exe /SILENT /SP- /SUPPRESSMSGBOXES /DIR=C:\local\boost
boost_1_80_0-msvc-14.3-64.exe /SILENT /SP- /SUPPRESSMSGBOXES /DIR=C:\local\boost

# build ore
cd C:\local\ore
mkdir build2
cd build2
SET BOOST_ROOT=C:\local\boost
#SET LIBPATH=C:\local2\boost_wazoo\lib64-msvc-14.3_wazoo
"C:\Program Files\CMake\bin\cmake.exe" -G "Visual Studio 17 2022" -A x64 ..
"C:\Program Files\CMake\bin\cmake.exe" --build . --config Release

"C:\Program Files\CMake\bin\cmake.exe" --build . --config Release --verbose
"C:\Program Files\CMake\bin\cmake.exe" -DCMAKE_LIBRARY_PATH=C:\local2\boost_wazoo\lib64-msvc-14.3_wazoo --build . --config Release
"C:\Program Files\CMake\bin\cmake.exe" --build . --config Release -- LIBPATH=C:\local2\boost_wazoo\lib64-msvc-14.3_wazoo
"C:\Program Files\CMake\bin\cmake.exe" --help
"C:\Program Files\CMake\bin\cmake.exe" --help-policy CMP0074
"C:\Program Files\CMake\bin\cmake-gui.exe" ..

# build oreswig
"C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat"
cd C:\local\oreswig\OREAnalytics-SWIG\Python
SET BOOST_ROOT=C:\local\boost
SET BOOST_LIB=C:\local\boost\lib64-msvc-14.3
SET ORE_DIR=C:\local\ore
SET PATH=%PATH%;C:\erik\ORE\repos\swigwin-4.1.1
python setup.py build
python setup.py test
#pip install build
python -m build --wheel

####################################################
# run cibuildwheels locally - windows

cd C:\erik\ORE\repos\oreswig.github\OREAnalytics-SWIG\Python
python -m venv env1
.\env1\Scripts\activate.bat
pip install cibuildwheel

SET BOOST_ROOT=%DEMO_BOOST_ROOT%
SET BOOST_LIB=%DEMO_BOOST_LIB%
SET ORE_DIR=%DEMO_ORE_DIR%
SET PATH=%PATH%;%DEMO_SWIG_DIR%
SET ORE_STATIC_RUNTIME=1

SET CIBW_BUILD=cp310-win_amd64
SET CIBW_ARCHS_WINDOWS=AMD64
SET CIBW_BUILD_VERBOSITY=2

SET CIBW_BUILD=cp37-win32
SET CIBW_ARCHS_WINDOWS=x86
SET CIBW_BUILD_VERBOSITY=2

cibuildwheel --platform windows
deactivate
rmdir /s /q env1

# run cibuildwheels locally - linux

# ATTEMPT #1
cd /home/erik/quaternion/oreswig.eehlers2/OREAnalytics-SWIG/Python
python3 -m venv env1
. ./env1/bin/activate
pip install cibuildwheel
export CIBW_BUILD='cp310-manylinux_x86_64'
export CIBW_BUILD_VERBOSITY='2'
export CIBW_ENVIRONMENT_LINUX='CXXFLAGS="-O3 -g0"'
export CIBW_ENVIRONMENT_PASS_LINUX='CXXFLAGS'
export CIBW_BEFORE_ALL_LINUX='./before_all_linux.local.sh'
export CIBW_REPAIR_WHEEL_COMMAND_LINUX='LD_LIBRARY_PATH=/host/home/erik/quaternion/boost_1_81_0/stage/lib auditwheel repair -w {dest_dir} {wheel}'
cibuildwheel --platform linux
deactivate
rm -rf env1

# ATTEMPT #2
cd /home/erik/quaternion/oreswig.eehlers2/OREAnalytics-SWIG/Python
python3 -m venv env1
. ./env1/bin/activate
pip install cibuildwheel
export CIBW_BUILD='cp310-manylinux_x86_64'
export CIBW_BUILD_VERBOSITY='2'
export CIBW_ENVIRONMENT_LINUX='CXXFLAGS="-O3 -g0"'
export CIBW_ENVIRONMENT_PASS_LINUX='CXXFLAGS'
export CIBW_BEFORE_ALL_LINUX='./before_all_linux.local.sh'
export CIBW_REPAIR_WHEEL_COMMAND_LINUX='LD_LIBRARY_PATH=/host/home/erik/quaternion/boost_1_81_0/stage/lib auditwheel repair -w {dest_dir} {wheel}'
cibuildwheel --platform linux
deactivate
rm -rf env1

# include dirs
/host/home/erik/quaternion/boost_1_81_0
/host/home/erik/quaternion/ore.eehlers/QuantLib
/host/home/erik/quaternion/ore.eehlers/QuantExt
/host/home/erik/quaternion/ore.eehlers/OREData
/host/home/erik/quaternion/ore.eehlers/OREAnalytics

# link dirs
/host/home/erik/quaternion/boost_1_81_0/stage/lib
/host/home/erik/quaternion/ore.eehlers/build/QuantLib/ql
/host/home/erik/quaternion/ore.eehlers/build/OREAnalytics/orea
/host/home/erik/quaternion/ore.eehlers/build/QuantExt/qle
/host/home/erik/quaternion/ore.eehlers/build/OREData/ored

####################################################
# ninja

python3 /home/erik/projects/cmake/ninjatracing/ninjatracing .ninja_log > trace.json
/home/erik/quaternion/ore.eehlers/build/trace.json
####################################################

# OLD
# copy props files
"C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat"
msbuild ORE.sln -p:Configuration="Release" -p:Platform=x64
===

cmake version = 3.25.1
boost version = 1.81
my cmake complains about boost version >= 1.81.0
===

BOOST_LIBRARYDIR

CMake Warning (dev) at OREData/CMakeLists.txt:14 (find_package):
  Policy CMP0074 is not SET: find_package uses <PackageName>_ROOT variables.
  Run "cmake --help-policy CMP0074" for policy details.  Use the cmake_policy
  command to SET the policy and suppress this warning.

  Environment variable Boost_ROOT is SET to:

    C:\local\boost

  For compatibility, CMake is ignoring the variable.

*****************

# QL - using autotools / configure, same as github actions
./configure --prefix=/home/erik/quaternion/test_builds/install --disable-static --disable-test-suite --enable-unity-build CXXFLAGS="-O3 -g0"
date;make -j4 install;date

# QL - using the QL subset of the ORE CMake build
cmake ..
date;cmake --build .;date

# QL - unity on, tests & examples off, parallel
cmake -DCMAKE_UNITY_BUILD=ON -DQL_BUILD_EXAMPLES=OFF -DQL_BUILD_TEST_SUITE=OFF ..
date;cmake --build . -j 4;date

# ORE - same as github actions
cmake -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DBUILD_DOC=OFF ..
date;cmake --build .;date

# ORE - xxx
# QuantExt build fails with unity on
#cmake -DCMAKE_UNITY_BUILD=ON -DQL_BUILD_EXAMPLES=OFF -DQL_BUILD_TEST_SUITE=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DBUILD_DOC=OFF ..
cmake -DQL_BUILD_EXAMPLES=OFF -DQL_BUILD_TEST_SUITE=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DBUILD_DOC=OFF ..
date;cmake --build . -j 4;date

=====

cmake/commonSettings.cmake
-> check to see if that contains the setting that crashes the musllinux build

OREAnalytics/CMakeLists.txt
find_package (Boost REQUIRED COMPONENTS unit_test_framework regex date_time thread serialization system filesystem timer OPTIONAL_COMPONENTS chrono)
cmake --build . -j 4

=====
LINK : fatal error LNK1158: cannot run 'rc.exe'
I got this error when trying to run link.exe from the DOS command line.  The fix was either:

1) modify the PATH of the DOS command prompt:

SET PATH=%PATH%;C:\Program Files (x86)\Windows Kits\10\bin\10.0.22000.0\x64

2) or, run the command from the visual studio command prompt.

